<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TRT Tracker — Lite</title>
<meta name="theme-color" content="#111">
<style>
  :root{--bg:#0f1115;--card:#161a22;--ink:#e8ecf1;--muted:#a7b0bf;--accent:#6ae3ff}
  *{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{position:sticky;top:0;background:#0f1115e6;backdrop-filter:blur(8px);border-bottom:1px solid #151a24}
  .bar{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
  h1{margin:0;font-size:1rem}
  main{padding:14px;display:grid;gap:14px;max-width:840px;margin:0 auto}
  section{background:#161a22;border:1px solid #1d2330;border-radius:14px;padding:14px}
  h2{margin:.2rem 0 10px;font-size:1rem}
  label{display:block;margin:8px 0 4px;font-size:.9rem;color:var(--muted)}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3345;background:#111622;color:var(--ink);font-size:1rem}
  button.primary{background:#0d7fa0;border:none}
  table{width:100%;border-collapse:collapse;font-size:.92rem}
  th,td{padding:10px 6px;border-bottom:1px solid #222a3a;vertical-align:top}
  tr:hover td{background:#121829}
  .grid{display:grid;gap:10px}
  .grid.two{grid-template-columns:1fr 1fr}
  .grid.three{grid-template-columns:repeat(3,1fr)}
  .muted{color:var(--muted);font-size:.9rem}
  .pill{background:#1f2633;border:1px solid #2d3445;padding:6px 10px;border-radius:999px;font-size:.78rem;color:var(--muted)}
  .notice{padding:10px;border:1px dashed #334055;border-radius:10px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  @media (max-width:720px){.grid.two,.grid.three{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <h1>TRT Tracker — Lite</h1>
    <div class="flex">
      <span class="pill" id="protocol">No protocol</span>
      <button id="exportBtn">Export</button>
      <button id="importBtn">Import</button>
      <input id="importFile" type="file" accept=".json" style="display:none">
    </div>
  </div>
</header>

<main>
  <section id="next">
    <h2>Status</h2>
    <div class="grid three">
      <div class="notice"><div class="muted">Next dose</div><div id="nextDue">—</div><div class="muted" id="nextRel">Set protocol</div></div>
      <div class="notice"><div class="muted">Last injected</div><div id="last">—</div><div class="muted" id="lastSite">—</div></div>
      <div class="notice"><div class="muted">Streak</div><div id="streak">0</div><div class="muted">on-time</div></div>
    </div>
  </section>

  <section>
    <h2>Quick log injection</h2>
    <div class="grid two">
      <div><label>Date & time</label><input id="injDt" type="datetime-local"></div>
      <div><label>Dose (mg)</label><input id="dose" type="number" inputmode="decimal" placeholder="e.g. 80"></div>
    </div>
    <div class="grid two">
      <div><label>Volume (mL)</label><input id="vol" type="number" inputmode="decimal" placeholder="auto"></div>
      <div><label>Site</label>
        <select id="site">
          <option value="">Select</option>
          <option>Left ventrogluteal</option><option>Right ventrogluteal</option>
          <option>Left vastus</option><option>Right vastus</option>
          <option>Left deltoid</option><option>Right deltoid</option>
        </select>
        <div class="muted" id="siteHint">Rotation suggests next.</div>
      </div>
    </div>
    <div><label>Notes</label><input id="notes" placeholder="optional"></div>
    <div style="margin-top:8px"><button class="primary" id="log">Log injection</button></div>
    <div class="muted">Volume auto-calculates from concentration in Settings.</div>
  </section>

  <section>
    <h2>Protocol & settings</h2>
    <div class="grid two">
      <div><label>Compound</label>
        <select id="compound">
          <option>Testosterone Cypionate</option><option>Testosterone Enanthate</option>
          <option>Testosterone Propionate</option><option>Undecanoate (Nebido)</option><option>Other</option>
        </select>
      </div>
      <div><label>Concentration (mg/mL)</label><input id="conc" type="number" inputmode="decimal" placeholder="e.g. 200"></div>
    </div>
    <div class="grid three">
      <div><label>Frequency (days)</label><input id="freq" type="number" inputmode="decimal" step="0.1" placeholder="e.g. 3.5"></div>
      <div><label>Typical dose (mg)</label><input id="typDose" type="number" inputmode="decimal" placeholder="e.g. 80"></div>
      <div><label>Rotate sites</label>
        <select id="sites" multiple size="6">
          <option>Left ventrogluteal</option><option>Right ventrogluteal</option>
          <option>Left vastus</option><option>Right vastus</option>
          <option>Left deltoid</option><option>Right deltoid</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px"><button class="primary" id="save">Save settings</button></div>
    <div class="muted" style="margin-top:8px">Data stays on your device (localStorage). Export to back up.</div>
  </section>

  <section>
    <h2>History</h2>
    <table id="tbl"><thead><tr><th>Date</th><th>Dose</th><th>Vol</th><th>Site</th><th>Notes</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </section>
</main>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={key:'trt-lite-v1',load(){try{return JSON.parse(localStorage.getItem(this.key))||{settings:{},logs:[],streak:0}}catch(e){return{settings:{},logs:[],streak:0}}},save(d){localStorage.setItem(this.key,JSON.stringify(d))}};
let state=store.load();

function fmt(dt){const d=new Date(dt);return isNaN(d)?'—':d.toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
function days(a,b){return(b-a)/(1000*60*60*24)}
function round(x,n=2){return (Math.round((x+Number.EPSILON)*10**n)/10**n).toFixed(n)}
function selectedSites(){return $$('#sites option').filter(o=>o.selected).map(o=>o.value)}
function nextSite(){const sel=selectedSites(); if(!sel.length) return ''; if(!state.logs.length) return sel[0]; const last=state.logs[state.logs.length-1].site; const i=sel.indexOf(last); return sel[(i+1)%sel.length]}

function loadSettings(){
  $('#compound').value=state.settings.compound||'Testosterone Cypionate';
  $('#conc').value=state.settings.conc??'';
  $('#freq').value=state.settings.freq??'';
  $('#typDose').value=state.settings.typDose??'';
  const set=new Set(state.settings.sites||[]);
  $$('#sites option').forEach(o=>o.selected=set.has(o.value));
  updateProtocol(); updateStatus(); $('#siteHint').textContent='Next suggested: '+(nextSite()||'—');
}
function updateProtocol(){
  const s=state.settings; $('#protocol').textContent=(s.compound||'No protocol')+(s.typDose?` • ${s.typDose} mg`:'' )+(s.freq?` • every ${s.freq} d`:'');
}
$('#save').onclick=()=>{
  state.settings={compound:$('#compound').value, conc:parseFloat($('#conc').value||''), freq:parseFloat($('#freq').value||''), typDose:parseFloat($('#typDose').value||''), sites:selectedSites()};
  store.save(state); updateProtocol(); loadSettings(); alert('Settings saved');
};

$('#dose').addEventListener('input', ()=>{ const c=state.settings.conc, d=parseFloat($('#dose').value||''); if(c&&d){$('#vol').value=round(d/c,3)} });

$('#log').onclick=()=>{
  const dt = $('#injDt').value ? new Date($('#injDt').value) : new Date();
  const dose= parseFloat($('#dose').value || state.settings.typDose || 0);
  const vol  = $('#vol').value ? parseFloat($('#vol').value) : (state.settings.conc ? dose/state.settings.conc : 0);
  const site = $('#site').value || nextSite() || '';
  const notes=$('#notes').value.trim();
  if(!dose || !site){ alert('Dose and site required'); return; }
  const entry={id:crypto.randomUUID(), date:dt.toISOString(), dose, volume:vol?Number(vol.toFixed(3)):null, site, notes};
  state.logs.push(entry); state.logs.sort((a,b)=>new Date(a.date)-new Date(b.date));
  store.save(state); renderTable(); updateStatus();
  $('#injDt').value=''; $('#vol').value=''; $('#site').value=''; $('#notes').value='';
  alert('Logged');
};

function renderTable(){
  const tb=$('#tbl tbody'); tb.innerHTML='';
  [...state.logs].reverse().forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.dose??''}</td><td>${r.volume??''}</td><td>${r.site??''}</td><td>${r.notes??''}</td>`;
    const td=document.createElement('td'); 
    const e=document.createElement('button'); e.textContent='Edit'; e.onclick=()=>editRow(r.id); 
    const d=document.createElement('button'); d.textContent='Delete'; d.onclick=()=>delRow(r.id);
    td.appendChild(e); td.appendChild(d); tr.appendChild(td); tb.appendChild(tr);
  });
}
function editRow(id){
  const r=state.logs.find(x=>x.id===id); if(!r) return;
  const dose=prompt('Dose (mg):', r.dose??''); if(dose===null) return;
  const vol=prompt('Volume (mL):', r.volume??''); const site=prompt('Site:', r.site??''); const notes=prompt('Notes:', r.notes??'');
  if(dose!=='') r.dose=parseFloat(dose); if(vol!=='') r.volume=parseFloat(vol); r.site=site||''; r.notes=notes||'';
  store.save(state); renderTable(); updateStatus();
}
function delRow(id){
  if(!confirm('Delete this entry?')) return;
  state.logs=state.logs.filter(x=>x.id!==id); store.save(state); renderTable(); updateStatus();
}

function updateStatus(){
  if(!state.logs.length){ $('#nextDue').textContent='—'; $('#nextRel').textContent='Set protocol and log one'; $('#last').textContent='—'; $('#lastSite').textContent='—'; $('#streak').textContent=state.streak||0; return;}
  const last=new Date(state.logs[state.logs.length-1].date); $('#last').textContent=fmt(last);
  $('#lastSite').textContent=state.logs[state.logs.length-1].site||'—';
  const f=state.settings.freq;
  if(!f){ $('#nextDue').textContent='—'; $('#nextRel').textContent='Set frequency (days)'; return;}
  const next=new Date(last.getTime()+f*24*60*60*1000); const now=new Date();
  const diff=days(now,next); $('#nextDue').textContent=fmt(next); $('#nextRel').textContent= diff>=0?`${round(diff,1)} days`:`${round(-diff,1)} days overdue`;
  // streak
  let st=0;
  for(let i=1;i<state.logs.length;i++){ const prev=new Date(state.logs[i-1].date), curr=new Date(state.logs[i].date); const d=days(prev,curr); if(Math.abs(d-(f||0))<=0.75) st++; else st=0; }
  state.streak=st; store.save(state); $('#streak').textContent=st;
}

// export/import
$('#exportBtn').onclick=()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'})); a.download='trt-lite-backup.json'; a.click(); };
$('#importBtn').onclick=()=>$('#importFile').click();
$('#importFile').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{const data=JSON.parse(r.result); if(!data||!Array.isArray(data.logs)||!data.settings){alert('Invalid file'); return;} state=data; store.save(state); loadSettings(); renderTable(); updateStatus(); alert('Imported');}catch(err){alert('Could not read file')}}; r.readAsText(f); });

// init
window.addEventListener('load', ()=>{
  const now=new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); $('#injDt').value=now.toISOString().slice(0,16);
  loadSettings(); renderTable(); updateStatus();
});
</script>
</body>
</html>
