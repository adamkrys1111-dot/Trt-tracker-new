<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TRT Tracker</title>
<meta name="theme-color" content="#0b0c10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/png" href="favicon.png">
<style>
:root{
  --bg:#0b0c10; --card:#12131a; --ink:#f2f4f8; --muted:#9aa6bd; --line:#202434;
  --red:#ff3b30; --red2:#ff594f; --redDeep:#d7261d; --char:#0f1117;
  --good:#39d98a; --warn:#f6c76e; --bad:#ff6b6b;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
header{position:sticky;top:0;background:linear-gradient(180deg,#0b0c10,rgba(11,12,16,.85));backdrop-filter:blur(10px);border-bottom:1px solid #141826;z-index:3}
.bar{display:flex;justify-content:space-between;align-items:center;padding:12px 14px}
h1{margin:0;font-size:1.05rem;letter-spacing:.4px}
.app{padding:14px;max-width:980px;margin:0 auto;display:grid;gap:14px}
.count-wrap{background:radial-gradient(1000px 500px at 50% -200px, rgba(255,59,48,.25), transparent), var(--card);
  border:1px solid #1b2133;border-radius:18px;padding:18px;display:grid;gap:8px}
.count-title{font-size:.95rem;color:var(--muted)}
.count-main{font-variant-numeric:tabular-nums;display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.countdown{font-size:2rem;font-weight:700;letter-spacing:.5px}
.countdown.ok{color:#ff857f} .countdown.soon{color:#ffc48f} .countdown.overdue{color:#ff9ba3}
.count-next{color:#bcc7de}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid #2a3248;background:#121827;color:#c9d3ea;border-radius:999px;padding:6px 10px;font-size:.82rem}
.card{background:var(--card);border:1px solid #1b2133;border-radius:18px;padding:16px}
h2{margin:0 0 10px;font-size:1rem}
label{display:block;margin:10px 0 6px;color:#c7d0e0;font-size:.92rem}
input,select,button,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3348;background:#0f1422;color:var(--ink);font-size:1rem;outline:none}
input:focus,select:focus,textarea:focus{border-color:var(--red2);box-shadow:0 0 0 3px rgba(255,59,48,.15)}
button.primary{background:linear-gradient(180deg,var(--red2),var(--redDeep));border:none;color:white;font-weight:600}
button.ghost{background:#121827;border:1px dashed #2b3348;color:#d5def2}
.grid{display:grid;gap:12px}
.two{grid-template-columns:1fr 1fr}
.three{grid-template-columns:repeat(3,1fr)}
@media (max-width:720px){.two,.three{grid-template-columns:1fr}}
.history-wrap{display:grid;gap:12px;max-height:420px;overflow:auto;padding-right:4px}
.history-wrap::-webkit-scrollbar{width:8px}
.history-wrap::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#2a3248,#3a415a);border-radius:8px}
.h-item{background:linear-gradient(180deg,#12141d,#0f121b);border:1px solid #232a40;border-radius:16px;padding:12px 12px 10px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.h-header{display:flex;justify-content:space-between;align-items:center}
.h-date{font-weight:700}
.h-dose{color:#ff857f}
.h-meta{color:#9fb0cc;font-size:.9rem;margin-top:6px}
.h-actions{display:flex;gap:6px;margin-top:10px}
.h-actions button{padding:8px 10px;border-radius:10px}
.h-del{background:#2a3248;border:1px solid #3b4562;color:#f3f6ff}
.h-edit{background:#151b2a;border:1px solid #2a3248;color:#cbd7ef}
.muted{color:#9aa6bd;font-size:.9rem}
.pill{background:#1f2633;border:1px solid #2d3445;padding:6px 10px;border-radius:999px;font-size:.78rem;color:#c3cee4}
.line{height:1px;background:linear-gradient(90deg,transparent,#232a3d,transparent)}
</style>
</head>
<body>
<header>
  <div class="bar">
    <h1>TRT Tracker</h1>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span class="pill" id="protocol">No protocol</span>
      <button id="exportBtn" class="ghost">Export</button>
      <button id="importBtn" class="ghost">Import</button>
      <input id="importFile" type="file" accept=".json" style="display:none">
    </div>
  </div>
</header>

<div class="app">
  <section class="count-wrap">
    <div class="count-title">Next injection</div>
    <div class="count-main">
      <div id="countdown" class="countdown ok">—</div>
      <div id="nextDue" class="count-next">—</div>
    </div>
    <div class="chips">
      <div class="chip">Last: <span id="last">—</span></div>
      <div class="chip">Site: <span id="lastSite">—</span></div>
      <div class="chip">Streak: <span id="streak">0</span></div>
    </div>
  </section>

  <section class="card">
    <h2>New injection</h2>
    <div class="grid two">
      <div>
        <label for="injDt">Date & time</label>
        <input id="injDt" type="datetime-local">
      </div>
      <div>
        <label for="dose">Dose (mg)</label>
        <input id="dose" type="number" inputmode="decimal" placeholder="e.g. 80">
      </div>
    </div>
    <div class="grid two">
      <div>
        <label for="vol">Volume (mL)</label>
        <input id="vol" type="number" inputmode="decimal" placeholder="auto">
      </div>
      <div>
        <label for="site">Site</label>
        <select id="site">
          <option value="">Select</option>
          <option>Left ventrogluteal</option><option>Right ventrogluteal</option>
          <option>Left vastus</option><option>Right vastus</option>
          <option>Left deltoid</option><option>Right deltoid</option>
        </select>
      </div>
    </div>
    <div>
      <label for="notes">Notes</label>
      <input id="notes" placeholder="optional">
    </div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="primary" id="log">Save injection</button>
      <button class="ghost" id="suggestSite">Suggest site</button>
    </div>
    <div class="muted" style="margin-top:6px">Tip: dose/volume auto-calc from Settings concentration.</div>
  </section>

  <section class="card">
    <h2 style="display:flex;justify-content:space-between;align-items:center">
      <span>History</span>
      <span class="muted" id="historyCount">0 entries</span>
    </h2>
    <div class="history-wrap" id="history"></div>
  </section>

  <section class="card">
    <h2>Protocol & settings</h2>
    <div class="grid two">
      <div>
        <label>Compound</label>
        <select id="compound">
          <option>Testosterone Cypionate</option><option>Testosterone Enanthate</option>
          <option>Testosterone Propionate</option><option>Undecanoate (Nebido)</option><option>Other</option>
        </select>
      </div>
      <div>
        <label>Concentration (mg/mL)</label>
        <input id="conc" type="number" inputmode="decimal" placeholder="e.g. 200">
      </div>
    </div>
    <div class="grid three">
      <div>
        <label>Frequency (days)</label>
        <input id="freq" type="number" inputmode="decimal" step="0.1" placeholder="e.g. 3.5">
      </div>
      <div>
        <label>Typical dose (mg)</label>
        <input id="typDose" type="number" inputmode="decimal" placeholder="e.g. 80">
      </div>
      <div>
        <label>Rotate sites</label>
        <select id="sites" multiple size="6">
          <option>Left ventrogluteal</option><option>Right ventrogluteal</option>
          <option>Left vastus</option><option>Right vastus</option>
          <option>Left deltoid</option><option>Right deltoid</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <button class="primary" id="save">Save settings</button>
      <span class="muted" style="margin-left:10px">Data stays on this device (localStorage). Export to back up.</span>
    </div>
  </section>

</div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store={key:'trt-lite-pro',load(){try{return JSON.parse(localStorage.getItem(this.key))||{settings:{},logs:[],streak:0}}catch(e){return{settings:{},logs:[],streak:0}}},save(d){localStorage.setItem(this.key,JSON.stringify(d))}};
let state=store.load();
let timer=null;

function fmt(dt){const d=new Date(dt);return isNaN(d)?'—':d.toLocaleString([], {year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'})}
function days(a,b){return(b-a)/(1000*60*60*24)}
function round(x,n=2){return (Math.round((x+Number.EPSILON)*10**n)/10**n).toFixed(n)}
function pad(n){return String(n).padStart(2,'0')}
function selectedSites(){return $$('#sites option').filter(o=>o.selected).map(o=>o.value)}
function nextSite(){const sel=selectedSites(); if(!sel.length) return ''; if(!state.logs.length) return sel[0]; const last=state.logs[state.logs.length-1].site; const i=sel.indexOf(last); return sel[(i+1)%sel.length]}

function loadSettings(){
  $('#compound').value=state.settings.compound||'Testosterone Cypionate';
  $('#conc').value=state.settings.conc??'';
  $('#freq').value=state.settings.freq??'';
  $('#typDose').value=state.settings.typDose??'';
  const set=new Set(state.settings.sites||[]);
  $$('#sites option').forEach(o=>o.selected=set.has(o.value));
  updateProtocol(); updateStatus();
}
function updateProtocol(){
  const s=state.settings; $('#protocol').textContent=(s.compound||'No protocol')+(s.typDose?` • ${s.typDose} mg`:'' )+(s.freq?` • every ${s.freq} d`:'');
}
$('#save').onclick=()=>{
  state.settings={compound:$('#compound').value, conc:parseFloat($('#conc').value||''), freq:parseFloat($('#freq').value||''), typDose:parseFloat($('#typDose').value||''), sites:selectedSites()};
  store.save(state); updateProtocol(); loadSettings(); alert('Settings saved');
};

$('#dose').addEventListener('input', ()=>{ const c=state.settings.conc, d=parseFloat($('#dose').value||''); if(c&&d){$('#vol').value=round(d/c,3)} });
$('#suggestSite').onclick=()=>{ const s=nextSite()||'—'; alert('Suggested site: '+s); if(!$('#site').value && s!=='—'){ $('#site').value=s; } };

$('#log').onclick=()=>{
  const dt = $('#injDt').value ? new Date($('#injDt').value) : new Date();
  const dose= parseFloat($('#dose').value || state.settings.typDose || 0);
  const vol  = $('#vol').value ? parseFloat($('#vol').value) : (state.settings.conc ? dose/state.settings.conc : 0);
  const site = $('#site').value || nextSite() || '';
  const notes=$('#notes').value.trim();
  if(!dose || !site){ alert('Dose and site required'); return; }
  const entry={id:crypto.randomUUID(), date:dt.toISOString(), dose, volume:vol?Number(vol.toFixed(3)):null, site, notes};
  state.logs.push(entry); state.logs.sort((a,b)=>new Date(a.date)-new Date(b.date));
  store.save(state); renderHistory(); updateStatus();
  $('#injDt').value=''; $('#vol').value=''; $('#site').value=''; $('#notes').value='';
};

function renderHistory(){
  const box=$('#history'); box.innerHTML='';
  const logs=[...state.logs].reverse();
  $('#historyCount').textContent = logs.length + (logs.length===1?' entry':' entries');
  logs.forEach(r=>{
    const wrap=document.createElement('div'); wrap.className='h-item';
    const head=document.createElement('div'); head.className='h-header';
    const left=document.createElement('div');
    left.innerHTML = `<div class="h-date">${fmt(r.date)}</div><div class="h-meta">${r.site||''} · <span class="h-dose">${(r.dose??'')} mg</span> ${r.volume?`· ${r.volume} mL`:''} ${r.notes?`· ${r.notes}`:''}</div>`;
    const actions=document.createElement('div'); actions.className='h-actions';
    const edit=document.createElement('button'); edit.className='h-edit'; edit.textContent='Edit';
    const del=document.createElement('button'); del.className='h-del'; del.textContent='Delete';
    edit.onclick = ()=> editRow(r.id);
    del.onclick  = ()=> delRow(r.id);
    actions.appendChild(edit); actions.appendChild(del);
    head.appendChild(left); head.appendChild(actions);
    wrap.appendChild(head);
    box.appendChild(wrap);
  });
}

function editRow(id){
  const r=state.logs.find(x=>x.id===id); if(!r) return;
  const dose=prompt('Dose (mg):', r.dose??''); if(dose===null) return;
  const vol=prompt('Volume (mL):', r.volume??''); const site=prompt('Site:', r.site??''); const notes=prompt('Notes:', r.notes??'');
  if(dose!=='') r.dose=parseFloat(dose); if(vol!=='') r.volume=parseFloat(vol); r.site=site||''; r.notes=notes||'';
  store.save(state); renderHistory(); updateStatus();
}
function delRow(id){
  if(!confirm('Delete this entry?')) return;
  state.logs=state.logs.filter(x=>x.id!==id); store.save(state); renderHistory(); updateStatus();
}

function updateCountdown(next){
  clearInterval(timer);
  const el=$('#countdown');
  if(!next){ el.textContent='—'; el.className='countdown ok'; return; }
  function tick(){
    const now=new Date();
    let ms= next - now; el.className='countdown ok';
    if(ms<0){ ms = -ms; el.classList.add('overdue'); }
    else if (ms <= 36*60*60*1000){ el.classList.add('soon'); }
    const d=Math.floor(ms/(24*60*60*1000));
    const h=Math.floor((ms%(24*60*60*1000))/(60*60*1000));
    const m=Math.floor((ms%(60*60*1000))/(60*1000));
    const s=Math.floor((ms%(60*1000))/1000);
    el.textContent = (next-now>0?'in ':'overdue ') + `${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  tick(); timer=setInterval(tick,1000);
}

function updateStatus(){
  if(!state.logs.length){
    $('#nextDue').textContent='—'; $('#last').textContent='—'; $('#lastSite').textContent='—'; $('#streak').textContent=state.streak||0; updateCountdown(null); return;
  }
  const last=new Date(state.logs[state.logs.length-1].date);
  $('#last').textContent=fmt(last);
  $('#lastSite').textContent=state.logs[state.logs.length-1].site||'—';
  const f=state.settings.freq;
  if(!f){ $('#nextDue').textContent='—'; updateCountdown(null); return; }
  const next=new Date(last.getTime()+f*24*60*60*1000);
  $('#nextDue').textContent = 'Due: ' + fmt(next);
  let st=0;
  for(let i=1;i<state.logs.length;i++){ const prev=new Date(state.logs[i-1].date), curr=new Date(state.logs[i].date); const d=days(prev,curr); if(Math.abs(d-(f||0))<=0.75) st++; else st=0; }
  state.streak=st; store.save(state); $('#streak').textContent=st;
  updateCountdown(next);
}

// export/import
$('#exportBtn').onclick=()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(state,null,2)],{type:'application/json'})); a.download='trt-lite-backup.json'; a.click(); };
$('#importBtn').onclick=()=>$('#importFile').click();
$('#importFile').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{const data=JSON.parse(r.result); if(!data||!Array.isArray(data.logs)||!data.settings){alert('Invalid file'); return;} state=data; store.save(state); loadSettings(); renderHistory(); updateStatus(); alert('Imported');}catch(err){alert('Could not read file')}}; r.readAsText(f); });

window.addEventListener('load', ()=>{
  const now=new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); $('#injDt').value=now.toISOString().slice(0,16);
  loadSettings(); renderHistory(); updateStatus();
});
</script>
</body>
</html>
